<chatwee-initialize>
  <!-- {%- assign userInfernoId = data.CurrentViewingUser.Id -%}
  {%- assign userFirstName = data.CurrentViewingUser.FirstName -%}
  {%- assign userLastName = data.CurrentViewingUser.LastName -%} -->

  <!-- get duration till end of conference plus one day for buffer -->
  <!-- this determines the length of time to set the chatwee cookie expiration too -->
  {%- assign eventsByDate = data.Events | sort: "StartTime" -%}
  {%- assign lastEvent = eventsByDate.last -%}

  {%- assign eventStart = lastEvent.StartTime | date: "%s" | plus: 0 -%}
  {%- assign eventEnd = eventStart | plus: lastEvent.VideoDuration -%}
  {%- assign nowTimestamp = "now" | date: "%s" | plus: 0 -%}

  <!-- difference in seconds -->
  {%- assign diffSeconds = eventEnd | minus:nowTimestamp -%}
  {%- assign secondsInADay = 5 | times: 24 | times: 60 | times: 60 -%}
  {%- assign chatDuration = diffSeconds | plus: secondsInADay -%}

  <div style="display:none;">
    <p id="user-inferno-first-name">${firstName}</p>
    <p id="user-inferno-last-name">${lastName}</p>
  </div>

  <script async>

    var userInfernoId = window.sessionStorage.getItem("userId");
    var firstName = window.isLocalTemplate ? 'TEST' : landingPageEl.getElementById("user-inferno-first-name").innerHTML;
    var lastName = window.isLocalTemplate ? 'USER' : landingPageEl.getElementById("user-inferno-last-name").innerHTML;

    var chatDuration = "{{ chatDuration }}";
    var hasProfileImage = false;

    // global chat manager
    var chatManager = null;

    var chatweeValues = {
      userIdKey: "chatwee-user-id",
      sessionCookieKey: "chatwee-SID-5f7ef4b1ebaa9f3cf83ed7fa",
      chatId: "5f7ef4b1ebaa9f3cf83ed7fa",
      clientApiKey: "a6feff42c070b4633a876aec",
      isAdmin: 0,
      ssoBaseUrl: "https://chatwee-api.com/v2/sso-user/"
    }

    var loadChatScript = () => {
      // don't load script if already on page
      let chatScript = document.getElementById("chat-script");
      if (chatScript) return;

      (function () {
        var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
        s1.id = "chat-script";
        s1.async = true;
        s1.src = 'https://static.chatwee-api.com/v2/script.js';
        s1.charset = 'UTF-8';
        s0.parentNode.insertBefore(s1, s0);
      })();

      return;
    }

    var loadChatStyles = () => {
      return;  // no custom styling for this instance

      // dont load styles if already on page
      // let chatStyleSheet = document.getElementById("chat-replacement-styling");
      // if (chatStyleSheet) return;
      //
      // (function () {
      //   var link1 = document.createElement("link"), body = document.getElementsByTagName("body")[0];
      //
      //   link1.setAttribute("id", "chat-replacement-styling")
      //   link1.setAttribute("rel", "stylesheet")
      //   link1.setAttribute("type", "text/css")
      //   link1.setAttribute("href", "https://studio304nextechar.freetls.fastly.net/infernoAR/arc2020/assets/chat-styling.css")
      //   link1.setAttribute("media", "all")
      //   body.parentNode.insertBefore(link1, body);
      // })();

      return;
    }

    var startChat = async () => {
      if (!chatManager) {
        chatManager = new ChatweeLib.ChatweeManager(chatweeValues.chatId);
        chatManager.Run();
      }
    }

    var openChat = () => {
      // close bubble
      let bubbleChild = document.getElementsByClassName('chch-fixedChatweeWindowSwitch')[0];
      let bubble = bubbleChild.parentNode;
      bubble.style.display = "none";

      // open chat
      let chatChild = document.getElementsByClassName('chch-resizablePane')[0];
      let chat = chatChild.parentNode;
      chat.style.display = "block";
      return;
    }

    // Chatwee UserId must be set as the Id for the button
    var triggerConversation = e => {
      let userId = e.target.id;
      openChat();
      chatManager.TriggerConversation(userId);
    }

    // helper functions
    var getCookie = key => {
      let cookieValue = "";

      const cookieList = document.cookie;
      if (cookieList) {
        const cookie = cookieList
          .split("; ")
          .find(row => row.startsWith(key));

        if (cookie) {
          cookieValue = cookie.split("=")[1];
        }

      }
      return cookieValue;
    }

    var setCookie = (key, value, age) => {
      document.cookie = key + "=" + value + "; max-age=" + age + "; path=/";
    }

    var validateChatSessionId = sessionId => {
      const url = chatweeValues.ssoBaseUrl
        + "validate-session?"
        + "chatId="
        + chatweeValues.chatId
        + "&clientKey="
        + chatweeValues.clientApiKey
        + "&sessionId="
        + sessionId;

      return fetch(url).then(res => res.json());
    }

    var loginChat = userId => {
      const url = chatweeValues.ssoBaseUrl
        + "login?"
        + "chatId="
        + chatweeValues.chatId
        + "&clientKey="
        + chatweeValues.clientApiKey
        + "&userId="
        + userId;

      return fetch(url).then(res => res.json());
    }

    var registerChat = () => {
      const name = firstName + " " + lastName;

      // TO DO: get default chat icon
      let avatarUrl = "https://studio304nextechar.freetls.fastly.net/infernoAR/halldale/chatwee/_avatar.jpg";

      if (hasProfileImage) avatarUrl = "https://ingress.infernocore.jolokia.com/api/ProfileImage/" + userInfernoId + "/70" + "/70";

      const url = chatweeValues.ssoBaseUrl
        + "register?"
        + "chatId="
        + chatweeValues.chatId
        + "&clientKey="
        + chatweeValues.clientApiKey
        + "&login="
        + name
        + "&isAdmin="
        + chatweeValues.isAdmin
        + "&avatar="
        + avatarUrl;

      return fetch(url).then(res => res.json());
    }

    // connect to Chatwee
    var connectChat = async () => {

      // see if session id locally
      let sessionId = getCookie(chatweeValues.sessionCookieKey);

      if (sessionId) {
        // validate session id with chatwee
        let valid
        try {
          valid = await validateChatSessionId(sessionId);
        } catch (e) {
          throw new Error(e);
        }

        // if true, do nothing
        if (valid) return;

      }

      // if false, check if user id is present locally
      const userId = getCookie(chatweeValues.userIdKey);

      // if true, login and set session id locally
      if (userId) {
        let sessionId = ""
        try {
          sessionId = await loginChat(userId);
        } catch (e) {
          throw new Error(e);
        }

        setCookie(chatweeValues.sessionCookieKey, sessionId, chatDuration);
      }
      // if false, register and set user id and log in user
      else {
        let userId = ""
        try {
          userId = await registerChat();
        } catch (e) {
          throw new Error(e);
        }

        setCookie(chatweeValues.userIdKey, userId, chatDuration);

        let sessionId = ""
        try {
          sessionId = await loginChat(userId);
        } catch (e) {
          throw new Error(e);
        }

        setCookie(chatweeValues.sessionCookieKey, sessionId, chatDuration);

      }

      return;
    }

    var getProfileImage = () => {
      let url = "https://ingress.infernocore.jolokia.com/api/ProfileImage/" + userInfernoId + "/1" + "/1";
      return fetch(url);
    }

    var waitForGlobal = async (key, callback1, callback2) => {
      if (window[key]) {
        await callback1();
        await callback2();
      } else {
        setTimeout(function () {
          waitForGlobal(key, callback1, callback2);
        }, 100);
      }
    };

    var setUpChat = async () => {
      loadChatScript();
      loadChatStyles();
      const res = await getProfileImage();
      if (res.status === 200) {
        hasProfileImage = true;
      }

      waitForGlobal("ChatweeLib", connectChat, startChat);
    }

    setUpChat();

  </script>

</chatwee-initialize>
